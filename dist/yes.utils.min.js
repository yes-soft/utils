"use strict";angular.module("yes.utils",[]),angular.module("yes.utils").factory("authInterceptor",["$rootScope","$q","$window","$location",function(e,t,n,r){var i=!0;return{request:function(e){return e},response:function(e){return e||t.when(e)},responseError:function(e){return 401===e.status&&i&&(i=!1,r.path("/login").search("return",encodeURIComponent(location.hash)),setTimeout(function(){i=!0},12e3)),t.reject(e)}}}]).config(["$httpProvider",function(e){e.defaults.withCredentials=!0,e.interceptors.push("authInterceptor")}]),angular.module("yes.utils").factory("explain",["$stateParams","oPath","utils",function(e,t,n){var r=n.settings||{},i=angular.element(document.body).injector(),o=function(e,t){for(var n={},r=0;r<e.length;++r)e[r].hasOwnProperty(t)?n[e[r][t]]=e[r]:n[r]=e[r];return n},a=function(e,t){try{return i.get(e+".config")[t]}catch(n){return null}},u=function(e,t){angular.isFunction(e)?i.invoke(e,t):angular.isArray(e)&&angular.forEach(e,function(e){u(e,t)})},l=function(e,n){var r=t.get(e,"operation",[]);if(!r)return e;var o=[],a={add:{name:"新建",action:n.action.create},del:{name:"删除",action:n.action.del}},u={scope:n};return angular.forEach(r,function(e,t){if(e){var n=a[t]||{name:e.name,action:e.action};angular.isFunction(e.action)&&(n.action=function(){i.invoke(e.action,u)}),o.push(n)}}),e.operations=o,e},c=function(e,n){var r={scope:n,list:e.list},i=t.get(e,"list.resolves",[]);return u(i,r),e},s=function(e,t,n){e&&(e[t]=e[t]||angular.copy(n))},f=function(e,t){if(!e)throw"can not override properties with null";for(var n in t)t.hasOwnProperty(n)&&s(e,n,t[n])},p=function(e,n){var r=t.get(e,"schema.properties",{});angular.isArray(r)&&(e.schema.properties=o(r,"key"));var i={scope:n,form:e.form};angular.isArray(e.form)&&angular.forEach(e.form,function(t){angular.forEach(t.items,function(t){("datepicker"==t.type||"datetimepicker"==t.type)&&(t.title=t.title||e.schema.properties[t.key].title,t.open=function(e){e.preventDefault(),e.stopPropagation(),t.opened=!0}),angular.isObject(t)&&(t.required=t.required||e.schema.properties[t.key].required)})});var a=t.get(e,"resolves",[]);return u(a,i),e},g=function(t){if(!angular.isUndefined(t)){if(0==t.indexOf("http")||t.indexOf("plugins")>-1)return t;var i=[r.pluginFolder,e.name,"templates",t].join("/").replace(/\/\//g,"/");return[n.root,i].join("/")}},d=function(){var t=a(e.name,"_default")||{};return t=angular.extend({list:{},form:{}},t),s(t.form,"template",[n.root,plugins.templates.detail].join("/")),s(t.list,"template",[n.root,plugins.templates.list].join("/")),s(t.list,"pageSize",r.pageSize["default"]),t};return{configuration:function(t){var n=d(),r=a(e.name,e.page)||{};return s(r,"form",{}),s(r,"list",{}),f(r.form,n.form),f(r.list,n.list),r.list.template=g(r.list.template),r.form.template=g(r.form.template),r=l(r,t),r=c(r,t),r.form=p(r.form,t),r}}}]),angular.module("yes.utils").factory("fileSize",function(){function e(e,t){return e&&e.toLowerCase()===t.toLowerCase()}var t="BKMGTPEZY".split("");return function(n,r){return n="number"==typeof n?n:0,r=r||{},r.fixed="number"==typeof r.fixed?r.fixed:2,r.spacer="string"==typeof r.spacer?r.spacer:" ",r.calculate=function(t){var i,o=e(t,"si")?["k","B"]:["K","iB"],a=e(t,"si")?1e3:1024,u=Math.log(n)/Math.log(a)|0,l=n/Math.pow(a,u),c=l.toFixed(r.fixed);return 3>u-1&&!e(t,"si")&&e(t,"jedec")&&(o[1]="B"),i=u?(o[0]+"MGTPEZY")[u-1]+o[1]:1===(0|c)?"Byte":"Bytes",{suffix:i,magnitude:u,result:l,fixed:c,bits:{result:l/8,fixed:(l/8).toFixed(r.fixed)}}},r.to=function(r,i){var o=e(i,"si")?1e3:1024,a=t.indexOf("string"==typeof r?r[0].toUpperCase():"B"),u=n;if(-1===a||0===a)return u.toFixed(2);for(;a>0;a--)u/=o;return u.toFixed(2)},r.human=function(e){var t=r.calculate(e);return t.fixed+r.spacer+t.suffix},r}}),angular.module("yes.utils").factory("menu",["$http","$q","$location","utils",function(e,t,n,r){var i={},o=r.settings||{},a=function(e,t,n){if(angular.isUndefined(e))return[];e.parents=e.parents||[];var r=n.filter(function(e){return e.uid==t.parent});0==e.parents.length&&e.parents.push(e.label),r.length&&(e.parents.push(r[0].name),a(e,r[0],n))},u=function(e){(angular.isUndefined(e.url)||"#"==e.url)&&(e.url=""),0===e.url.indexOf("/")&&angular.isDefined(o.serverRoot)&&(e.url=o.serverRoot+e.url)},l=function(e){angular.forEach(e,function(e){u(e),angular.isString(e.uid)&&e.parent&&e.type&&"menu"==e.type.toLowerCase()&&(i[e.parent]=i[e.parent]||[],i[e.parent].push(e))})},c=function(e,t){l(t);var n=t.filter(function(t){return t.subMenus=i[t.uid],t.parent==e});return console.log(n),n};return{initMenus:c,buildMenuTree:function(e){var t=[];return angular.forEach(e,function(n){var r={label:n.name,url:n.url,parent:n.parent,uid:n.uid};a(r,r,e),r.name=r.parents.reverse().join(" > "),t.push(r)}),t}}}]),angular.module("yes.utils").factory("oPath",[function(){var e;return e=function(){function e(e){if(!e)return!0;if(f(e)&&0===e.length)return!0;if(!c(e)){for(var t in e)if(u.call(e,t))return!1;return!0}return!1}function t(e){return a.call(e)}function n(e){return"boolean"==typeof e||"[object Boolean]"===t(e)}function r(e){var t=parseInt(e);return t.toString()===e?t:e}function i(t,n,o,a){if(l(n)&&(n=[n]),e(n))return t;if(c(n))return i(t,n.split(".").map(r),o,a);var u=n[0];if(1===n.length){var s=t[u];return void 0!==s&&a||(t[u]=o),s}return void 0===t[u]&&(t[u]=l(n[1])?[]:{}),i(t[u],n.slice(1),o,a)}function o(t,n){if(l(n)&&(n=[n]),e(t))return void 0;if(e(n))return t;if(c(n))return o(t,n.split("."));var i=r(n[0]),a=t[i];if(1===n.length)void 0!==a&&(f(t)?t.splice(i,1):delete t[i]);else if(void 0!==t[i])return o(t[i],n.slice(1));return t}var a=Object.prototype.toString,u=Object.prototype.hasOwnProperty,l=angular.isNumber,c=angular.isString,s=angular.isObject,f=angular.isArray,p=function(e){return Object.keys(p).reduce(function(t,n){return"function"==typeof p[n]&&(t[n]=p[n].bind(p,e)),t},{})};return p.has=function(t,n){if(e(t))return!1;if(l(n)?n=[n]:c(n)&&(n=n.split(".")),e(n)||0===n.length)return!1;for(var r=0;r<n.length;r++){var i=n[r];if(!s(t)&&!f(t)||!u.call(t,i))return!1;t=t[i]}return!0},p.ensureExists=function(e,t,n){return i(e,t,n,!0)},p.set=function(e,t,n,r){return i(e,t,n,r)},p.insert=function(e,t,n,r){var i=p.get(e,t);r=~~r,f(i)||(i=[],p.set(e,t,i)),i.splice(r,0,n)},p.empty=function(t,r){if(e(r))return t;if(e(t))return void 0;var i,o;if(!(i=p.get(t,r)))return t;if(c(i))return p.set(t,r,"");if(n(i))return p.set(t,r,!1);if(l(i))return p.set(t,r,0);if(f(i))i.length=0;else{if(!s(i))return p.set(t,r,null);for(o in i)u.call(i,o)&&delete i[o]}},p.push=function(e,t){var n=p.get(e,t);f(n)||(n=[],p.set(e,t,n)),n.push.apply(n,Array.prototype.slice.call(arguments,2))},p.coalesce=function(e,t,n){for(var r,i=0,o=t.length;o>i;i++)if(void 0!==(r=p.get(e,t[i])))return r;return n},p.find=function(t,n,i){if(l(n)&&(n=[n]),e(n))return t;if(e(t))return i;c(n)&&p.find(t,n.split("."),i);var o=r(n[0]);if(/\[(.*?)\]/g.test(o)&&f(t))for(var a=/\[(.*?)\]/g.exec(o)[1],u=a.split(":"),s=0;s<t.length;s++)if(t[s].hasOwnProperty(u[0])&&t[s][u[0]]==u[1])return p.find(t[s],n.slice(1),i);return 1===n.length?void 0===t[o]?i:t[o]:p.find(t[o],n.slice(1),i)},p.get=function(t,n,i){if(l(n)&&(n=[n]),e(n))return t;if(e(t))return i;if(c(n))return p.get(t,n.split("."),i);var o=r(n[0]);return 1===n.length?void 0===t[o]?i:t[o]:p.get(t[o],n.slice(1),i)},p.del=function(e,t){return o(e,t)},p}()}]),angular.module("yes.utils").factory("utils",["$http","$q","$location","$stateParams",function(e,t,n,r){var i=angular.element(document.body).injector(),o={version:"0.0.0",templates:{layout:"base/templates/layout.html",login:"base/templates/login.html",dashboard:"base/templates/dashboard.html",list:"base/templates/list.uigrid.html",detail:"base/templates/detail.html",searchCommon:"base/templates/search-common.html"},gateway:{host:"self"},runtime:{mock:!0,menuRoot:null,menuApi:"base/menus",language:navigator.language||navigator.userLanguage,apiPath:"api",serverRoot:"src",pluginFolder:"plugins",pageSize:{"default":20,more:10},debug:!0}};i.has("settings")&&(o=i.get("settings")||{});var a=o.headers,u=o.gateway,l={async:function(n,r,i,o){var u={method:n,url:r,cache:!1,headers:o||a};i&&angular.forEach(i,function(e,t){""==e&&delete i[t]}),i&&("post"==n.toLowerCase()||"put"==n.toLowerCase())&&a["Content-Type"].indexOf("json")>0?u.data=i:i&&(u.data=this.serialize(i));var l=t.defer();return r?(u.data&&"get"==u.method.toLowerCase()&&(u.url=u.url+"?"+u.data),e(u).success(function(e){0!=e.error&&e.error?l.reject(e.message?e:{message:"服务器异常"}):l.resolve(e)}).error(function(e){l.reject({message:"无法连接到服务器"})}),l.promise):void l.reject({message:"Uri is empty!"})},serialize:function(e){if(!angular.isObject(e))return null==e?"":e.toString();var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];angular.isDate(r)&&moment&&(r=moment(r).format("YYYY-MM-DD HH:mm:ss")),t.push(encodeURIComponent(n)+"="+encodeURIComponent(null==r?"":r))}var i=t.join("&");return i},createDoc:function(e){return e&&e.properties&&angular.isArray(e.properties)&&(angular.forEach(e.properties,function(t){e[t.name]=1==t.value.length?t.value[0]:t.value}),delete e.properties),e}},c={defaults:"ico ico-file ico-file-1",xls:"ico ico-file ico-file-2",xlsx:"ico ico-file ico-file-2",doc:"ico ico-file ico-file-3",docx:"ico ico-file ico-file-3",ppt:"ico ico-file ico-file-4",pptx:"ico ico-file ico-file-4",rar:"ico ico-file ico-file-6",zip:"ico ico-file ico-file-7",html:"ico ico-file ico-file-10",js:"ico ico-file ico-file-11",xml:"ico ico-file ico-file-12",css:"ico ico-file ico-file-12",pdf:"ico ico-file ico-file-17",txt:"ico ico-file ico-file-22",jpg:"ico ico-file ico-file-31",gif:"ico ico-file ico-file-32",png:"ico ico-file ico-file-33",bmp:"ico ico-file ico-file-34"},s=function(){var e={};return{on:function(t,n){return t.split(" ").forEach(function(t){e[t]||(e[t]=[]),e[t].push(n)}),this},once:function(t,n){return t.split(" ").forEach(function(t){e[t]=[],e[t].push(n)}),this},trigger:function(t,n){return angular.forEach(e[t],function(e){e.call(null,n)}),this}}},f=new s,p=function(e){try{return angular.element(document.body).injector().get(e)}catch(t){return null}},g="self"!==u.host?u.host:location.protocol+"//"+location.host,d=g+location.pathname.substr(0,location.pathname.lastIndexOf("/")),m=function(e){var t=e.split("/");return o.runtime.mock&&t.length?"data/"+t.slice(3).join(".")+".json":e},h=function(e){var t=e;return 0==e.indexOf("http")?t=e:(0!==e.indexOf(o.runtime.apiPath)&&(t=[o.runtime.apiPath,e].join("/").replace(/\/\//g,"/")),t=[g,t].join("/")),t};return{settings:o,alert:function(e,t){console.log(e,t)},root:d,host:g,getAbsUrl:h,serialize:l.serialize,format:function(e){var t=Array.prototype.slice.call(arguments,1);return e?e.replace(/{(\d+)}/g,function(e,n){return"undefined"!=typeof t[n]?t[n]:e}):""},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},createEvents:function(){return new s},events:f,changeTitle:function(e){f.trigger("changeTitle",e)},currentPage:function(){var e=n.search()[e];return parseInt(e)||1},async:function(e,t,n){var r=h(t);return r=m(r),l.async(e,r,n)},findViewConfig:function(e,t){return p(e+".config")[t]},disableScroll:function(){document.body.style.overflow="hidden",angular.element(window).trigger("resize")},resetScroll:function(){document.body.style.overflow=null,angular.element(window).trigger("resize")},getFileExtCss:function(e){var t=/(?:\.([^.]+))?$/,n=t.exec(e)[1];return c.hasOwnProperty(n)?c[n]:c.defaults},dialogUpload:function(e){}}}]);