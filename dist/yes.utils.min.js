"use strict";angular.module("yes.utils",["yes.auth"]),angular.module("yes.utils").provider("utils",[function(){var e=this;e.settings={version:"0.0.0",language:navigator.language||navigator.userLanguage,templates:{layout:"base/templates/layout.html",login:"base/templates/login.html",dashboard:"base/templates/dashboard.html",list:"base/templates/list.uigrid.html",detail:"base/templates/detail.html",searchCommon:"base/templates/search-common.html"},host:"self",mock:!0,debug:!0,pageSize:{defaults:20,more:10},headers:{"Content-Type":"application/json"},runtime:{menuRoot:null,menuApi:"base/menus",apiPath:"api",serverRoot:"src",pluginFolder:"plugins"}};var t={};e.getSettings=function(){return e.settings},e.getService=function(e){var t=angular.element("body").injector();return t.has(e)?t.get(e):{}},e.addModule=function(e,r){t[e]=r};this.$get=function(){return t}}]),angular.module("yes.utils").config(["utilsProvider",function(e){var t=function(t,r,n,i){var a=e.getService("$http"),o=e.getService("$q"),u=e.getSettings(),s={method:t,url:r,cache:!1,headers:i||u.headers};n&&angular.forEach(n,function(e,t){""==e&&delete n[t]}),n&&("post"==t.toLowerCase()||"put"==t.toLowerCase())&&headers["Content-Type"].indexOf("json")>0?s.data=n:n&&(s.data=this.serialize(n));var l=o.defer();return r?(s.data&&"get"==s.method.toLowerCase()&&(s.url=s.url+"?"+s.data),a(s).success(function(e){0!=e.error&&e.error?l.reject(e.message?e:{message:"服务器异常"}):l.resolve(e)}).error(function(e){l.reject({message:"无法连接到服务器"})}),l.promise):void l.reject({message:"Uri is empty!"})};e.addModule("async",t)}]),angular.module("yes.auth",[]).factory("authInterceptor",["$q","$location",function(e,t){var r=!0;return{request:function(e){return e},response:function(t){return t||e.when(t)},responseError:function(n){return 401===n.status&&r&&(r=!1,t.path("/login").search("return",encodeURIComponent(location.hash)),setTimeout(function(){r=!0},12e3)),e.reject(n)}}}]).config(["$httpProvider",function(e){e.defaults.withCredentials=!0,e.interceptors.push("authInterceptor")}]),angular.module("yes.utils").config(["utilsProvider",function(e){function t(e,t){return e&&e.toLowerCase()===t.toLowerCase()}function r(e,r){return e="number"==typeof e?e:0,r=r||{},r.fixed="number"==typeof r.fixed?r.fixed:2,r.spacer="string"==typeof r.spacer?r.spacer:" ",r.calculate=function(n){var i,a=t(n,"si")?["k","B"]:["K","iB"],o=t(n,"si")?1e3:1024,u=Math.log(e)/Math.log(o)|0,s=e/Math.pow(o,u),l=s.toFixed(r.fixed);return 3>u-1&&!t(n,"si")&&t(n,"jedec")&&(a[1]="B"),i=u?(a[0]+"MGTPEZY")[u-1]+a[1]:1===(0|l)?"Byte":"Bytes",{suffix:i,magnitude:u,result:s,fixed:l,bits:{result:s/8,fixed:(s/8).toFixed(r.fixed)}}},r.to=function(r,i){var a=t(i,"si")?1e3:1024,o=n.indexOf("string"==typeof r?r[0].toUpperCase():"B"),u=e;if(-1===o||0===o)return u.toFixed(2);for(;o>0;o--)u/=a;return u.toFixed(2)},r.human=function(e){var t=r.calculate(e);return t.fixed+r.spacer+t.suffix},r}var n="BKMGTPEZY".split("");e.addModule("getFileSize",r)}]),angular.module("yes.utils").factory("interpreter",["$stateParams","oPath","utils",function(e,t,r){var n=r.settings,i=function(e,t){for(var r={},n=0;n<e.length;++n)e[n].hasOwnProperty(t)?r[e[n][t]]=e[n]:r[n]=e[n];return r},a=function(e,t){try{return injector.get(e+".config")[t]}catch(r){return null}},o=function(e,t){angular.isFunction(e)?injector.invoke(e,t):angular.isArray(e)&&angular.forEach(e,function(e){o(e,t)})},u=function(e,r){var n=t.get(e,"operation",[]);if(!n)return e;var i=[],a={add:{name:"新建",action:r.action.create},del:{name:"删除",action:r.action.del}},o={scope:r};return angular.forEach(n,function(e,t){if(e){var r=a[t]||{name:e.name,action:e.action};angular.isFunction(e.action)&&(r.action=function(){injector.invoke(e.action,o)}),i.push(r)}}),e.operations=i,e},s=function(e,r){var n={scope:r,list:e.list},i=t.get(e,"list.resolves",[]);return o(i,n),e},l=function(e,t,r){e&&(e[t]=e[t]||angular.copy(r))},f=function(e,t){if(!e)throw"can not override properties with null";for(var r in t)t.hasOwnProperty(r)&&l(e,r,t[r])},c=function(e,r){var n=t.get(e,"schema.properties",{});angular.isArray(n)&&(e.schema.properties=i(n,"key"));var a={scope:r,form:e.form};angular.isArray(e.form)&&angular.forEach(e.form,function(t){angular.forEach(t.items,function(t){("datepicker"==t.type||"datetimepicker"==t.type)&&(t.title=t.title||e.schema.properties[t.key].title,t.open=function(e){e.preventDefault(),e.stopPropagation(),t.opened=!0}),angular.isObject(t)&&(t.required=t.required||e.schema.properties[t.key].required)})});var u=t.get(e,"resolves",[]);return o(u,a),e},p=function(t){if(!angular.isUndefined(t)){if(0==t.indexOf("http")||t.indexOf("plugins")>-1)return t;var i=[n.pluginFolder,e.name,"templates",t].join("/").replace(/\/\//g,"/");return[r.root,i].join("/")}},d=function(){var t=a(e.name,"_default")||{};return t=angular.extend({list:{},form:{}},t),l(t.form,"template",[r.root,plugins.templates.detail].join("/")),l(t.list,"template",[r.root,plugins.templates.list].join("/")),l(t.list,"pageSize",n.pageSize["default"]),t};return{configuration:function(t){var r=d(),n=a(e.name,e.page)||{};return l(n,"form",{}),l(n,"list",{}),f(n.form,r.form),f(n.list,r.list),n.list.template=p(n.list.template),n.form.template=p(n.form.template),n=u(n,t),n=s(n,t),n.form=c(n.form,t),n}}}]),angular.module("yes.utils").config(["utilsProvider",function(e){var t={},r=e.settings,n=function(e,t,r){if(angular.isUndefined(e))return[];e.parents=e.parents||[];var i=r.filter(function(e){return e.uid==t.parent});0==e.parents.length&&e.parents.push(e.label),i.length&&(e.parents.push(i[0].name),n(e,i[0],r))},i=function(e){(angular.isUndefined(e.url)||"#"==e.url)&&(e.url=""),0===e.url.indexOf("/")&&angular.isDefined(r.serverRoot)&&(e.url=r.serverRoot+e.url)},a=function(e){angular.forEach(e,function(e){i(e),angular.isString(e.uid)&&e.parent&&e.type&&"menu"==e.type.toLowerCase()&&(t[e.parent]=t[e.parent]||[],t[e.parent].push(e))})},o=function(e,r){a(r);var n=r.filter(function(r){return r.subMenus=t[r.uid],r.parent==e});return console.log(n),n},u={initMenus:o,buildMenuTree:function(e){var t=[];return angular.forEach(e,function(r){var i={label:r.name,url:r.url,parent:r.parent,uid:r.uid};n(i,i,e),i.name=i.parents.reverse().join(" > "),t.push(i)}),t}};e.addModule("menus",u)}]),angular.module("yes.utils").config(["utilsProvider",function(e){var t;t=function(){function e(e){if(!e)return!0;if(c(e)&&0===e.length)return!0;if(!l(e)){for(var t in e)if(u.call(e,t))return!1;return!0}return!1}function t(e){return o.call(e)}function r(e){return"boolean"==typeof e||"[object Boolean]"===t(e)}function n(e){var t=parseInt(e);return t.toString()===e?t:e}function i(t,r,a,o){if(s(r)&&(r=[r]),e(r))return t;if(l(r))return i(t,r.split(".").map(n),a,o);var u=r[0];if(1===r.length){var f=t[u];return void 0!==f&&o||(t[u]=a),f}return void 0===t[u]&&(t[u]=s(r[1])?[]:{}),i(t[u],r.slice(1),a,o)}function a(t,r){if(s(r)&&(r=[r]),e(t))return void 0;if(e(r))return t;if(l(r))return a(t,r.split("."));var i=n(r[0]),o=t[i];if(1===r.length)void 0!==o&&(c(t)?t.splice(i,1):delete t[i]);else if(void 0!==t[i])return a(t[i],r.slice(1));return t}var o=Object.prototype.toString,u=Object.prototype.hasOwnProperty,s=angular.isNumber,l=angular.isString,f=angular.isObject,c=angular.isArray,p=function(e){return Object.keys(p).reduce(function(t,r){return"function"==typeof p[r]&&(t[r]=p[r].bind(p,e)),t},{})};return p.has=function(t,r){if(e(t))return!1;if(s(r)?r=[r]:l(r)&&(r=r.split(".")),e(r)||0===r.length)return!1;for(var n=0;n<r.length;n++){var i=r[n];if(!f(t)&&!c(t)||!u.call(t,i))return!1;t=t[i]}return!0},p.ensureExists=function(e,t,r){return i(e,t,r,!0)},p.set=function(e,t,r,n){return i(e,t,r,n)},p.insert=function(e,t,r,n){var i=p.get(e,t);n=~~n,c(i)||(i=[],p.set(e,t,i)),i.splice(n,0,r)},p.empty=function(t,n){if(e(n))return t;if(e(t))return void 0;var i,a;if(!(i=p.get(t,n)))return t;if(l(i))return p.set(t,n,"");if(r(i))return p.set(t,n,!1);if(s(i))return p.set(t,n,0);if(c(i))i.length=0;else{if(!f(i))return p.set(t,n,null);for(a in i)u.call(i,a)&&delete i[a]}},p.push=function(e,t){var r=p.get(e,t);c(r)||(r=[],p.set(e,t,r)),r.push.apply(r,Array.prototype.slice.call(arguments,2))},p.coalesce=function(e,t,r){for(var n,i=0,a=t.length;a>i;i++)if(void 0!==(n=p.get(e,t[i])))return n;return r},p.find=function(t,r,i){if(s(r)&&(r=[r]),e(r))return t;if(e(t))return i;l(r)&&p.find(t,r.split("."),i);var a=n(r[0]);if(/\[(.*?)\]/g.test(a)&&c(t))for(var o=/\[(.*?)\]/g.exec(a)[1],u=o.split(":"),f=0;f<t.length;f++)if(t[f].hasOwnProperty(u[0])&&t[f][u[0]]==u[1])return p.find(t[f],r.slice(1),i);return 1===r.length?void 0===t[a]?i:t[a]:p.find(t[a],r.slice(1),i)},p.get=function(t,r,i){if(s(r)&&(r=[r]),e(r))return t;if(e(t))return i;if(l(r))return p.get(t,r.split("."),i);var a=n(r[0]);return 1===r.length?void 0===t[a]?i:t[a]:p.get(t[a],r.slice(1),i)},p.del=function(e,t){return a(e,t)},p}(),e.addModule("oPath",t)}]),angular.module("yes.utils").config(["utilsProvider",function(e){var t=function(e){if(!angular.isObject(e))return null==e?"":e.toString();var t=[];for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];angular.isDate(n)&&moment&&(n=moment(n).format("YYYY-MM-DD HH:mm:ss")),t.push(encodeURIComponent(r)+"="+encodeURIComponent(null==n?"":n))}var i=t.join("&");return i};e.addModule("serialize",t)}]);